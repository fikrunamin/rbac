<div class="container">
  <div class="row mb-3">
    <div class="col">
      <h2>Daftar Pesanan</h2>
    </div>
  </div>

  <% if (error && error.length > 0) { %>
    <div class="alert alert-danger">
      <%= error %>
    </div>
  <% } %>

  <% if (success && success.length > 0) { %>
    <div class="alert alert-success">
      <%= success %>
    </div>
  <% } %>

  <div class="card">
    <div class="card-body">
      <table id="datatable" class="table table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>Pelanggan</th>
            <th>Tanggal</th>
            <th>Status</th>
            <th>Aksi</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<script>
  $(document).ready(function() {
    $('#datatable').DataTable({
      serverSide: true,
      processing: true,
      ajax: '/pesanan/datatable',
      columns: [
        { data: 'id' },
        { 
          data: 'pelanggan_nama',
          render: function(data, type, row) {
            return `<a href="/pelanggan/${row.pelanggan_id}/pesanan">${data}</a>`;
          }
        },
        { 
          data: 'tanggal_pesanan',
          render: function(data) {
            return new Date(data).toLocaleDateString('id-ID');
          }
        },
        { 
          data: 'status',
          render: function(data) {
            const badges = {
              'pending': 'warning',
              'diproses': 'primary',
              'selesai': 'success',
              'dibatalkan': 'danger'
            };
            return `<span class="badge bg-${badges[data]}">${data.toUpperCase()}</span>`;
          }
        },
        {
          data: null,
          orderable: false,
          render: function(data, type, row) {
            let buttons = `
              <div class="btn-group" role="group">
                <a href="/pesanan/${row.id}" class="btn btn-sm btn-info">Detail</a>
                <a href="/pembayaran/${row.id}" class="btn btn-sm btn-primary">Pembayaran</a>
                <a href="/pengiriman/${row.id}" class="btn btn-sm btn-success">Pengiriman</a>
            `;

            if (row.status === 'pending') {
              buttons += `
                <form action="/pesanan/${row.id}?_method=DELETE" method="POST" class="d-inline" 
                      onsubmit="return confirm('Apakah Anda yakin ingin membatalkan pesanan ini?')">
                  <button type="submit" class="btn btn-sm btn-danger">Batalkan</button>
                </form>
              `;
            }

            buttons += '</div>';
            return buttons;
          }
        }
      ],
      language: {
        url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/id.json'
      }
    });
  });
</script>