<div class="container">
  <div class="row mb-3">
    <div class="col">
      <h2>Detail Pesanan #<%= pesanan.id %></h2>
    </div>
  </div>

  <% if (error && error.length > 0) { %>
    <div class="alert alert-danger">
      <%= error %>
    </div>
  <% } %>

  <% if (success && success.length > 0) { %>
    <div class="alert alert-success">
      <%= success %>
    </div>
  <% } %>

  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Informasi Pesanan</h5>
        </div>
        <div class="card-body">
          <table class="table table-borderless">
            <tr>
              <td width="40%">Status</td>
              <td>
                <span class="badge bg-<%= pesanan.status === 'selesai' ? 'success' : 
                                      pesanan.status === 'diproses' ? 'primary' : 
                                      pesanan.status === 'dibatalkan' ? 'danger' : 'warning' %>">
                  <%= pesanan.status.toUpperCase() %>
                </span>
              </td>
            </tr>
            <tr>
              <td>Tanggal Pesanan</td>
              <td><%= new Date(pesanan.tanggal_pesanan).toLocaleDateString('id-ID') %></td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Informasi Pelanggan</h5>
        </div>
        <div class="card-body">
          <table class="table table-borderless">
            <tr>
              <td width="40%">Nama</td>
              <td><%= pesanan.pelanggan_nama %></td>
            </tr>
            <tr>
              <td>Email</td>
              <td><%= pesanan.pelanggan_email %></td>
            </tr>
            <tr>
              <td>Telepon</td>
              <td><%= pesanan.pelanggan_telepon %></td>
            </tr>
            <tr>
              <td>Alamat</td>
              <td><%= pesanan.pelanggan_alamat %></td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="card-title mb-0">Daftar Produk</h5>
    </div>
    <div class="card-body">
      <table id="datatable" class="table table-striped">
        <thead>
          <tr>
            <th>Produk</th>
            <th>Harga Satuan</th>
            <th>Jumlah</th>
            <th>Subtotal</th>
          </tr>
        </thead>
      </table>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Pembayaran</h5>
        </div>
        <div class="card-body">
          <% if (pesanan.status !== 'dibatalkan') { %>
            <a href="/pembayaran/<%= pesanan.id %>" class="btn btn-primary">
              <i class="bi bi-credit-card"></i> Lihat Pembayaran
            </a>
          <% } else { %>
            <p class="text-muted mb-0">Pesanan dibatalkan</p>
          <% } %>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Pengiriman</h5>
        </div>
        <div class="card-body">
          <% if (pesanan.status !== 'dibatalkan') { %>
            <a href="/pengiriman/<%= pesanan.id %>" class="btn btn-primary">
              <i class="bi bi-truck"></i> Lihat Pengiriman
            </a>
          <% } else { %>
            <p class="text-muted mb-0">Pesanan dibatalkan</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between">
    <a href="/pelanggan/<%= pesanan.pelanggan_id %>/pesanan" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Kembali
    </a>

    <% if (pesanan.status === 'pending') { %>
      <form action="/pesanan/<%= pesanan.id %>?_method=DELETE" method="POST" class="d-inline" 
            onsubmit="return confirm('Apakah Anda yakin ingin membatalkan pesanan ini?')">
        <button type="submit" class="btn btn-danger">
          <i class="bi bi-x-circle"></i> Batalkan Pesanan
        </button>
      </form>
    <% } %>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<script>
  $(document).ready(function() {
    $('#datatable').DataTable({
      serverSide: true,
      processing: true,
      ajax: '/pesanan/<%= pesanan.id %>/produk/datatable',
      columns: [
        { data: 'nama' },
        { 
          data: 'harga_satuan',
          render: function(data) {
            return new Intl.NumberFormat('id-ID', {
              style: 'currency',
              currency: 'IDR'
            }).format(data);
          }
        },
        { data: 'jumlah' },
        { 
          data: null,
          render: function(data) {
            const subtotal = data.harga_satuan * data.jumlah;
            return new Intl.NumberFormat('id-ID', {
              style: 'currency',
              currency: 'IDR'
            }).format(subtotal);
          }
        }
      ],
      language: {
        url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/id.json'
      }
    });
  });
</script>